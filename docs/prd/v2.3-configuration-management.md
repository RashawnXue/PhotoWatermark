## PhotoWatermark PRD v2.3
### 4. 配置管理

### 4.1 水印模板（Template）
目标  
- 允许用户将当前所有水印相关设置保存为可复用的模板，便于在不同图片或会话中快速应用相同样式。  
- 提供模板的加载、管理与删除功能。  
- 程序启动时能自动恢复上次关闭时的设置；若不存在上次设置则加载一个默认模板。

功能需求（详尽）  
- 保存模板（Save Template）
  - 操作入口：在设置面板提供“保存为模板”按钮 / 菜单项。
  - 行为：保存当前水印相关的全部参数为一个命名模板（用户输入模板名称，允许覆盖同名模板或取消）。
  - 必保存项（数据模型字段，必须完整序列化）：
    - 模板元信息：模板名称（string, 必填, 唯一），创建时间（ISO8601），最后修改时间（ISO8601），可选 描述（string）。
    - 通用设置：watermark_type（timestamp/text/image），position（枚举），margin（int）。
    - 文本水印（当适用）：text（string），font_name/font_path（string），font_size（int or null），font_color（string），font_alpha（float 0..1），font_bold（bool），font_italic（bool），rotation（float），shadow_enabled/shadow_offset_x/shadow_offset_y/shadow_blur/shadow_color/shadow_alpha，stroke_enabled/stroke_color/stroke_width。
    - 图片水印（当适用）：image_path（string，模板保存时记录路径相对性/绝对性说明），scale_mode/scale_percentage/scale_width/scale_height/keep_aspect_ratio，alpha，rotation，flip_horizontal/flip_vertical。
    - 其他：任何影响水印外观的开关或参数（例如输出格式相关的 font_size 自适配开关等，若属于水印外观，则应包含）。
  - 存储格式：JSON 文件（键名与内部配置结构对应），单独模板为单一文件或集中在模板目录的索引文件中均可（实现需一致）。建议存放位置：用户配置目录下的 `templates/` 子目录（例如：`~/.local/share/PhotoWatermark/templates/` 或应用配置目录），并保证读写权限及跨平台路径兼容。

- 加载模板（Load / Apply Template）
  - 操作入口：模板管理器列表中的“应用”按钮或在模板条目双击应用；在保存/导出对话也可选择模板。
  - 行为：将模板内所有字段应用到当前会话的水印设置视图（UI控件同步更新），并触发预览刷新。
  - 校验：若模板中包含的字体文件或图片路径不存在，应：
    - 对字体：回退到默认字体并在 UI 中显示警告（但仍应用其它模板设置）。
    - 对图片水印路径：提示“水印图片未找到”，允许用户选择新路径或保留当前模板但禁用图片水印。
  - 不改变：模板应用仅改变水印设置，不自动保存为当前配置，除非用户选择“另存为当前设置”。

- 管理模板（List / Rename / Delete）
  - 列表视图：显示已保存模板的名称、创建/修改日期、缩略预览（若可行，缩略预览为小图或描述行）。支持按名称排序和按时间排序。
  - 重命名：允许修改模板名称（保持唯一性校验）。
  - 删除：允许删除模板（需二次确认对话以防误删）。
  - 复制/另存为（可选实现细节但非必须）：允许基于现有模板创建新模板（模板另存为），UI 提供“复制”或“另存为”操作。
  - 搜索/筛选（实现可选，不作为必须项）。

- 自动加载与启动行为
  - 功能要求：程序启动时自动恢复水印设置。
  - 优先级规则：
    1. 如果存在“上次会话设置”记录（最近退出时保存的完整设置），则自动加载该设置并恢复到 UI（默认行为）。
    2. 如果不存在上次会话设置，则加载“默认模板”。默认模板为程序自带的模板文件（随应用安装或首次启动创建），用户可在模板管理器中将任意模板标记为“默认”以替换内置默认模板。
  - 配置开关（可选默认行为）：在“配置管理”中显示当前自动加载来源并允许用户切换为“始终加载默认模板”或“始终加载上次设置”。（注：该功能为启动行为可配置项，但核心要求是程序需能自动加载上次或默认之一）

实现细节要求（必须明确）
- 原子保存：保存模板操作必须原子化（写入临时文件后改名覆盖）以防文件损坏。
- 兼容性与向后兼容：模板 JSON schema 应包含版本号字段（例如 template_version: "2.3"），以便未来升级兼容处理。
- 路径策略：对于包含外部资源（如图片路径、字体路径）的字段，模板应记录路径类型（absolute/relative）或额外存储资源元信息；在加载时优先尝试原路径，若失败按上述校验规则回退或提示用户。
- 权限与错误处理：当存储目录不可写时，向用户显示清晰错误并提供更改存储位置或以只读方式运行的选项。
- 数据保全：在程序正常退出时，自动保存“上次会话设置”到专用状态文件（例如 `last_session.json`），该文件仅用于启动恢复；该保存行为应尽量防止频繁磁盘写入（可在配置变更或退出时保存）。

交互与 UX（必须覆盖）
- 保存模板流程：
  1. 用户在设置面板对参数调整完成后，点击“保存为模板”。
  2. 弹出对话，要求输入模板名称（必填），可选描述，显示“覆盖同名模板？”复选（默认不覆盖）。
  3. 点击“保存”后成功提示并在模板管理器中出现新模板；若失败（磁盘、权限等），显示错误信息并保留当前 UI 状态。
- 模板管理器视图：
  - 列表：模板名、创建/修改日期、按模板预览小图（若为文本水印则渲染小图并缓存），操作按钮：应用、重命名、删除、设为默认（若支持）。
  - 操作反馈：应用后预览即时刷新；删除需二次确认并在删除后显示撤销提示（可选短期撤销操作）。
- 启动恢复：
  - 首次运行：若无上次会话，自动加载内置默认模板并在状态栏通知“已加载默认模板”。
  - 常规运行：启动后自动加载上次设置并在状态栏简短提示“已恢复上次设置（模板名/或未命名）”。

验收标准（Acceptance Criteria）
- 保存模板：在 UI 中保存模板后，模板文件真实存在于模板目录内，且在模板管理器列表中可见；应用该模板后，所有水印参数（至少上文列出的字段）都能恢复并在预览中正确呈现（字体、颜色、透明度、位置、旋转、阴影、描边等）。
- 加载模板：加载含缺失资源（如字体或图片路径错误）的模板时，系统能按策略回退并提示用户；其余参数仍正确应用。
- 管理模板：能列出、重命名、删除模板；重命名后列表更新且名称唯一性受保障；删除后模板文件被移除。
- 启动恢复：程序正常退出后重新启动，能自动恢复上次会话的水印设置；若上次设置不存在则加载默认模板。恢复后，UI 与预览反映该设置。
- 错误与边界：在磁盘写入失败或无权限情况下，用户会收到明确错误提示，并且不会导致程序崩溃或丢失原有配置。

测试用例（最小集）
- TC1 保存并应用：修改若干字体/颜色/位置/大小/透明度，保存为模板A，重启应用，打开模板A并应用，检查预览与原设置一致。
- TC2 覆盖检测：保存名为B的模板，再次保存名为B时选择不覆盖并取消，确保原模板未被改写；选择覆盖则内容被替换。
- TC3 资源缺失：创建模板指向不存在的图片路径，加载模板时确认提示出现并允许用户选择新路径或取消图片水印。
- TC4 启动恢复：修改设置但不保存为模板，退出程序后重启，确认恢复到上次会话设置。
- TC5 模板删除：删除模板C，确认模板文件被移除且在UI中不可见。

附注（仅致实现者）
- 模板 schema 必须记录版本信息以便未来迁移与兼容，不允许直接在模板内嵌入大型二进制资源（如图片）；若要打包模板与资源，需另行设计打包/导入流程（不属于本需求范围）。

---  
（结束：仅包含 4. 配置管理 与 4.1 水印模板的详尽 PRD，版本 v2.3）
