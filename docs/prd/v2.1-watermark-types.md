# PhotoWatermark v2.1 产品需求文档 - 水印类型功能

## 文档信息

- **版本**: v2.1
- **创建日期**: 2025-09-28
- **最后更新**: 2025-09-28
- **作者**: PhotoWatermark Team
- **状态**: ✅ 已完成

## 1. 概述

### 1.1 背景
PhotoWatermark v2.0 目前仅支持基于EXIF时间信息的文本水印功能。为了满足用户更多样化的水印需求，需要扩展水印类型支持，包括自定义文本水印和图片水印功能。

### 1.2 目标
- 提供灵活的文本水印自定义功能
- 支持图片水印（Logo等）功能
- 增强水印在复杂背景下的可读性和可见性
- 保持现有功能的向后兼容性

### 1.3 范围
本版本将新增两种水印类型：自定义文本水印和图片水印，同时保留原有的EXIF时间水印功能。

## 2. 功能需求

### 2.1 文本水印

#### 2.1.1 功能描述
用户可以创建和自定义文本水印，包括内容、外观样式和视觉效果。

#### 2.1.2 详细需求

##### 2.1.2.1 文本内容
- **自定义输入**：用户可输入任意文本内容作为水印
- **字符限制**：支持最多200个字符（中英文混合）
- **多行支持**：支持换行符，最多5行文本
- **特殊字符**：支持常用特殊字符和符号
- **编码支持**：完整支持UTF-8编码，包括中文、日文、韩文等

##### 2.1.2.2 字体设置
- **字体选择**：
  - 检测并列出系统已安装的字体
  - 提供常用字体的预览功能
  - 支持TrueType (.ttf) 和 OpenType (.otf) 字体
  - 默认提供系统标准字体作为备选
- **字号设置**：
  - 范围：12-200px
  - 支持精确数值输入
  - 提供滑块快速调节
  - 自动根据图片尺寸建议合适字号
- **字体样式**：
  - 粗体：支持加粗效果
  - 斜体：支持倾斜效果
  - 可同时应用粗体和斜体

##### 2.1.2.3 颜色设置
- **调色板**：
  - 提供标准色彩选择器
  - 支持RGB、HSV、十六进制颜色输入
  - 预设常用颜色快速选择
  - 颜色历史记录功能
- **渐变支持**：
  - 线性渐变（可选功能）
  - 径向渐变（可选功能）

##### 2.1.2.4 透明度控制
- **透明度范围**：0-100%
- **实时预览**：调整时实时显示效果
- **精确控制**：支持1%精度调节
- **快速设置**：提供25%、50%、75%、100%快速选项

##### 2.1.2.5 视觉增强效果
- **阴影效果**：
  - 开关控制：可启用/禁用阴影
  - 阴影颜色：可自定义阴影颜色
  - 偏移距离：X、Y方向偏移量（0-20px）
  - 模糊程度：阴影模糊半径（0-10px）
  - 阴影透明度：独立的透明度控制（0-100%）
- **描边效果**：
  - 开关控制：可启用/禁用描边
  - 描边颜色：可自定义描边颜色
  - 描边宽度：1-10px可调
  - 描边样式：实线描边
- **背景框**（可选功能）：
  - 半透明背景色块
  - 圆角矩形背景
  - 背景内边距调节

### 2.2 图片水印

#### 2.2.1 功能描述
用户可以使用图片（如Logo、签名等）作为水印添加到目标图片上。

#### 2.2.2 详细需求

##### 2.2.2.1 图片选择与导入
- **支持格式**：
  - PNG（推荐，支持透明通道）
  - JPEG（不支持透明）
  - GIF（支持透明，但转换为静态）
  - BMP（不支持透明）
- **文件大小限制**：单个水印图片不超过10MB
- **尺寸限制**：最大2000x2000像素
- **导入方式**：
  - 文件选择对话框
  - 拖拽导入
  - 最近使用的水印图片快速选择

##### 2.2.2.2 透明通道支持
- **PNG透明支持**：
  - 完整保留PNG的Alpha通道信息
  - 正确处理半透明像素
  - 支持复杂的透明边缘
- **透明度检测**：自动识别图片是否包含透明通道
- **非透明格式处理**：
  - 对于JPEG等格式，提供背景色移除功能（可选）
  - 支持指定背景色为透明

##### 2.2.2.3 尺寸调整
- **缩放模式**：
  - 按比例缩放：保持原始宽高比
  - 自由缩放：可独立调整宽度和高度
  - 适应目标：自动调整到目标图片的合适比例
- **尺寸设置**：
  - 百分比模式：相对于目标图片的百分比（5%-50%）
  - 像素模式：直接指定像素尺寸
  - 最小尺寸限制：不小于20x20像素
- **实时预览**：调整时实时显示缩放效果
- **高质量缩放**：使用高质量算法进行图片缩放

##### 2.2.2.4 透明度控制
- **整体透明度**：0-100%可调
- **独立于原始透明度**：在保持原有透明通道的基础上应用整体透明度
- **实时预览**：透明度调整时实时显示效果
- **预设选项**：提供常用透明度快速选择

##### 2.2.2.5 图片处理选项
- **旋转功能**：
  - 0-360度任意角度旋转
  - 90度快速旋转按钮
  - 保持图片质量的旋转算法
- **翻转功能**：
  - 水平翻转
  - 垂直翻转
- **色彩调整**（可选功能）：
  - 亮度调整
  - 对比度调整
  - 饱和度调整

## 3. 用户界面需求

### 3.1 水印类型选择
- **选项卡设计**：
  - "时间水印"（原有功能）
  - "文本水印"（新增）
  - "图片水印"（新增）
- **类型切换**：用户可随时切换水印类型
- **设置保持**：切换类型时保持各自的设置

### 3.2 文本水印界面
- **文本输入区**：多行文本输入框，支持实时字符计数
- **字体设置区**：字体选择下拉框、字号输入框、样式复选框
- **颜色设置区**：颜色选择器、透明度滑块
- **效果设置区**：阴影和描边选项的折叠面板
- **预览区域**：实时显示水印效果预览

### 3.3 图片水印界面
- **图片选择区**：缩略图显示、选择按钮、最近使用列表
- **尺寸调整区**：缩放模式选择、尺寸输入框、比例锁定
- **透明度控制**：透明度滑块和数值输入
- **变换选项**：旋转、翻转控制按钮
- **预览区域**：实时显示水印效果预览

### 3.4 通用界面元素
- **位置设置**：九宫格位置选择器（所有水印类型共用）
- **边距调整**：水印与图片边缘的距离设置
- **预览功能**：实时预览水印效果
- **重置按钮**：恢复默认设置
- **保存模板**：保存常用水印设置为模板

## 4. 技术需求

### 4.1 图像处理
- **文本渲染**：使用PIL的高质量文本渲染
- **图片合成**：支持Alpha通道的图片合成
- **抗锯齿**：文本和图片缩放时的抗锯齿处理
- **内存管理**：大图片处理时的内存优化

### 4.2 字体管理
- **系统字体检测**：跨平台的系统字体枚举
- **字体缓存**：字体对象的缓存机制
- **字体回退**：指定字体不可用时的回退机制

### 4.3 文件处理
- **图片格式支持**：PIL支持的所有常见格式
- **透明通道处理**：正确处理各种透明通道格式
- **文件验证**：水印图片的格式和完整性验证

### 4.4 性能要求
- **响应时间**：界面操作响应时间 < 100ms
- **预览生成**：预览图生成时间 < 500ms
- **批量处理**：支持大批量图片的水印处理
- **内存占用**：单张大图处理内存占用 < 500MB

## 5. 兼容性需求

### 5.1 向后兼容
- **配置文件**：兼容v2.0的配置文件格式
- **命令行接口**：保持原有CLI参数的兼容性
- **导出格式**：保持原有的导出格式支持

### 5.2 平台支持
- **操作系统**：Windows 10+、macOS 10.14+、Linux (Ubuntu 18.04+)
- **Python版本**：Python 3.8+
- **依赖库**：PIL/Pillow 8.0+

## 6. 质量需求

### 6.1 可用性
- **学习成本**：新用户能在5分钟内掌握基本操作
- **操作效率**：常用操作步骤不超过3步
- **错误处理**：友好的错误提示和恢复机制

### 6.2 可靠性
- **错误率**：正常使用场景下错误率 < 1%
- **数据安全**：不会损坏或覆盖原始图片
- **异常恢复**：程序异常时能保存用户设置

### 6.3 性能
- **处理速度**：单张图片处理时间 < 5秒（1920x1080分辨率）
- **内存使用**：稳定运行时内存占用 < 200MB
- **响应性**：UI操作响应时间 < 100ms

## 7. 测试需求

### 7.1 功能测试
- **水印类型切换**：各种水印类型间的切换测试
- **参数边界**：各种参数的边界值测试
- **格式兼容**：不同图片格式的水印处理测试
- **批量处理**：大量图片的批量水印测试

### 7.2 界面测试
- **响应性测试**：界面操作的响应性测试
- **预览准确性**：预览效果与最终效果的一致性测试
- **跨平台UI**：不同操作系统下的界面显示测试

### 7.3 性能测试
- **大图片处理**：高分辨率图片的处理性能测试
- **内存泄漏**：长时间运行的内存泄漏测试
- **并发处理**：多任务并发处理的稳定性测试

## 8. 交付标准

### 8.1 功能完整性
- 所有需求功能100%实现
- 通过完整的功能测试套件
- 用户验收测试通过

### 8.2 代码质量
- 代码覆盖率 > 80%
- 通过静态代码分析
- 符合团队编码规范

### 8.3 文档完备性
- 完整的用户使用手册
- 详细的API文档
- 部署和维护文档

## 9. 风险与约束

### 9.1 技术风险
- **字体兼容性**：不同系统字体的兼容性问题
- **透明通道处理**：复杂透明效果的处理难度
- **性能瓶颈**：大图片处理的性能限制

### 9.2 时间约束
- **开发周期**：预计开发周期8-10周
- **测试时间**：需要充分的测试时间确保质量
- **发布窗口**：需要考虑与其他版本的发布协调

### 9.3 资源约束
- **开发人力**：需要UI设计和图像处理专业技能
- **测试资源**：需要多平台测试环境
- **设计资源**：需要专业的UI/UX设计支持

## 10. 后续版本规划

### 10.1 v2.2计划功能
- 水印模板系统
- 批量水印设置
- 水印动画效果（GIF输出）

### 10.2 长期规划
- 矢量图形水印支持
- 水印位置的智能检测
- 基于AI的水印风格推荐

## 11. 实现状态

### 11.1 开发完成情况
- ✅ **核心架构**: 水印类型枚举和配置结构 - 已完成
- ✅ **文本水印功能**: 自定义文本、字体样式、视觉效果 - 已完成
- ✅ **图片水印功能**: 图片选择、缩放、透明度、变换 - 已完成
- ✅ **GUI界面**: 选项卡式界面、实时配置 - 已完成
- ✅ **后端集成**: GUI与处理引擎完整集成 - 已完成
- ✅ **格式兼容**: JPEG/PNG输出格式支持 - 已完成

### 11.2 功能验证
- ✅ 时间水印（原有功能）正常工作
- ✅ 文本水印支持多行文本、字体样式、阴影、描边
- ✅ 图片水印支持PNG透明通道、缩放、旋转
- ✅ GUI界面响应正常，配置项完整
- ✅ 导出功能支持所有水印类型

### 11.3 交付成果
- 📦 完整的水印类型系统
- 🎨 直观的图形用户界面
- 📚 详细的功能文档
- 🧪 完整的功能测试

---

**文档结束**

*PhotoWatermark v2.1 水印类型功能已于2025-09-28完成开发和测试*
