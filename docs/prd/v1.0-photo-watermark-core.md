# PhotoWatermark v1.0 核心功能 - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目名称
PhotoWatermark - 基于EXIF拍摄时间的图片水印工具

### 1.2 项目描述
一个命令行程序，能够自动读取图片的EXIF信息中的拍摄时间，并将其作为水印添加到图片上。用户可以自定义水印的字体大小、颜色和位置。

### 1.3 项目目标
- 提供简单易用的命令行界面
- 自动提取图片EXIF中的拍摄时间信息
- 支持批量处理多张图片
- 提供灵活的水印样式配置选项
- 保持原图不变，生成带水印的新图片

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 图片路径处理
- **输入**: 用户指定图片文件路径或目录路径
- **支持格式**: JPEG, PNG, TIFF等常见图片格式
- **批量处理**: 如果输入是目录，则处理目录下所有支持的图片文件
- **递归处理**: 可选择是否递归处理子目录

#### 2.1.2 EXIF信息提取
- **拍摄时间提取**: 读取EXIF中的DateTimeOriginal或DateTime字段
- **日期格式**: 提取年-月-日信息 (YYYY-MM-DD)
- **异常处理**: 对于没有EXIF信息或拍摄时间的图片给出明确提示
- **时间格式选项**: 支持多种日期显示格式 (如: 2024-03-15, 2024/03/15, 15 Mar 2024等)

#### 2.1.3 水印配置
- **字体大小**: 支持自定义字体大小 (默认: 自适应图片尺寸)
- **字体颜色**: 支持RGB颜色值或预定义颜色名称 (如: white, black, red等)
- **字体透明度**: 支持设置水印透明度 (0-100%)
- **字体样式**: 支持选择字体文件或使用系统默认字体
- **位置设置**: 
  - 预定义位置: 左上角、居中、右下角、左下角、右上角、顶部居中、底部居中
  - 自定义坐标: 支持像素坐标或百分比坐标
- **边距设置**: 水印距离边缘的距离

#### 2.1.4 图片处理与保存
- **水印绘制**: 将时间文本绘制到图片上
- **输出目录**: 在原目录下创建 `原目录名_watermark` 子目录
- **文件命名**: 保持原文件名，可选添加后缀标识
- **质量保持**: 尽可能保持原图质量
- **格式支持**: 支持输出为JPEG、PNG格式

### 2.2 辅助功能

#### 2.2.1 预览功能
- **水印预览**: 在实际处理前显示水印效果预览
- **批量预览**: 对于批量处理，显示前几张图片的预览效果

#### 2.2.2 配置管理
- **配置文件**: 支持保存和加载水印配置
- **模板管理**: 预定义多套水印样式模板

#### 2.2.3 日志与反馈
- **处理进度**: 显示批量处理的进度条
- **处理结果**: 显示成功/失败的文件统计
- **错误日志**: 详细记录处理失败的原因

## 3. 技术需求

### 3.1 编程语言选择
推荐使用 **Python**，理由如下：
- 丰富的图像处理库 (PIL/Pillow)
- 优秀的EXIF处理库 (exifread, piexif)
- 成熟的命令行参数解析库 (argparse, click)
- 跨平台兼容性好
- 开发效率高

### 3.2 核心依赖库
- **Pillow (PIL)**: 图像处理和水印绘制
- **exifread** 或 **piexif**: EXIF信息读取
- **click**: 命令行界面框架
- **tqdm**: 进度条显示
- **colorama**: 跨平台彩色终端输出

### 3.3 架构设计

#### 3.3.1 模块划分
```
photo_watermark/
├── __init__.py
├── cli.py              # 命令行入口
├── core/
│   ├── __init__.py
│   ├── exif_reader.py  # EXIF信息提取
│   ├── watermark.py    # 水印处理
│   ├── image_processor.py # 图像处理
│   └── config.py       # 配置管理
├── utils/
│   ├── __init__.py
│   ├── file_utils.py   # 文件操作工具
│   └── color_utils.py  # 颜色处理工具
└── templates/
    └── default_config.json # 默认配置模板
```

#### 3.3.2 设计原则
- **单一职责原则**: 每个模块只负责一个特定功能
- **开闭原则**: 易于扩展新的水印样式和图片格式
- **依赖倒置**: 使用接口抽象，便于测试和替换实现

## 4. 用户界面设计

### 4.1 命令行参数设计
```bash
python photo_watermark.py [OPTIONS] INPUT_PATH

选项:
  -o, --output DIR          输出目录 (默认: INPUT_PATH_watermark)
  -s, --font-size INT       字体大小 (默认: 自适应)
  -c, --color TEXT          字体颜色 (默认: white)
  -a, --alpha FLOAT         透明度 0-1 (默认: 0.8)
  -p, --position CHOICE     位置 [top-left|center|bottom-right|...] (默认: bottom-right)
  -m, --margin INT          边距像素 (默认: 20)
  -f, --format CHOICE       日期格式 [YYYY-MM-DD|YYYY/MM/DD|DD-MM-YYYY] (默认: YYYY-MM-DD)
  --font-path TEXT          自定义字体文件路径
  --recursive               递归处理子目录
  --preview                 预览模式，不保存文件
  --config FILE             使用配置文件
  --save-config FILE        保存当前配置
  -v, --verbose             详细输出
  --help                    显示帮助信息
```

### 4.2 使用示例
```bash
# 基本使用
python photo_watermark.py /path/to/photos

# 自定义样式
python photo_watermark.py /path/to/photos -c red -s 24 -p top-left

# 使用配置文件
python photo_watermark.py /path/to/photos --config my_style.json

# 预览效果
python photo_watermark.py /path/to/photos --preview

# 递归处理
python photo_watermark.py /path/to/photos --recursive
```

## 5. 质量要求

### 5.1 性能要求
- **处理速度**: 单张1920x1080图片处理时间 < 2秒
- **内存使用**: 处理大图片时内存使用合理，避免内存溢出
- **并发处理**: 支持多线程处理提升批量处理速度

### 5.2 兼容性要求
- **操作系统**: Windows, macOS, Linux
- **Python版本**: Python 3.8+
- **图片格式**: JPEG, PNG, TIFF, BMP

### 5.3 错误处理
- **输入验证**: 验证路径存在性和文件格式
- **异常捕获**: 妥善处理各种异常情况
- **用户友好**: 提供清晰的错误信息和解决建议

## 6. 测试计划

### 6.1 单元测试
- EXIF信息提取功能测试
- 水印绘制功能测试
- 配置管理功能测试
- 文件操作功能测试

### 6.2 集成测试
- 端到端处理流程测试
- 批量处理测试
- 不同图片格式兼容性测试

### 6.3 用户验收测试
- 不同操作系统环境测试
- 各种参数组合测试
- 异常情况处理测试

## 7. 项目交付

### 7.1 交付物
- 完整的源代码
- requirements.txt 依赖文件
- README.md 使用说明
- 测试用例和测试数据
- 配置文件模板

### 7.2 部署说明
- 安装依赖: `pip install -r requirements.txt`
- 运行程序: `python photo_watermark.py --help`
- 配置说明: 详细的参数配置指南

## 8. 版本规划

### 8.1 v1.0 (MVP)
- 基本的EXIF时间提取
- 简单的文本水印功能
- 基础的命令行参数
- 单张图片处理

### 8.2 v1.1
- 批量处理功能
- 更多位置选项
- 配置文件支持

### 8.3 v1.2
- 预览功能
- 更多字体和样式选项
- 性能优化

### 8.4 v2.0
- GUI界面
- 更多水印类型 (图片水印、Logo等)
- 插件系统

---

**文档版本**: 1.0  
**创建日期**: 2025-09-28  
**最后更新**: 2025-09-28  
**状态**: 已实现  
**实现状态**: ✅ 完成
